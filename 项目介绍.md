# 项目介绍：多模态 AI 交互示例 (输入增强)

## 1. 项目目标

本项目旨在提供一个基于 Web 的前端交互界面，用于与支持多模态输入（文本和图片）的 AI 模型进行对话。用户可以通过该界面发送文本消息、粘贴图片，并接收 AI 的流式响应，响应内容支持 Markdown 格式和代码块语法高亮。

## 2. 架构概览

这是一个纯粹的前端单页应用 (SPA)，不依赖任何后端框架。所有交互逻辑均通过客户端 JavaScript 实现。

*   **表示层 (View):** 由 `index.html` 定义页面结构，使用 `css/main.css` 进行自定义样式，并利用 `css/github.min.css` 实现代码块的 GitHub 风格高亮。
*   **逻辑层 (Logic):** 内嵌在 `index.html` 中的 JavaScript 代码负责处理用户输入（文本、图片粘贴）、与外部 AI API 的交互（请求发送、流式响应处理）、消息显示、Markdown 解析和代码高亮。
*   **外部服务 (Service):** 依赖一个外部 AI API (`https://snemc-geminibalance.hf.space/v1/chat/completions`) 来提供智能对话能力。

## 3. 技术栈

*   **核心语言:** HTML, CSS, JavaScript (ES6+)
*   **关键库:**
    *   `marked.js`: 用于将 AI 返回的 Markdown 文本解析为 HTML。
    *   `highlight.js`: 用于对 Markdown 中的代码块进行语法高亮。
*   **API:** `fetch` API (用于与外部 AI 服务通信)

## 4. 关键组件及其职责

*   **`index.html`:**
    *   定义应用的整体 HTML 结构，包括聊天显示区域、`contenteditable` 输入框、图片预览区、发送按钮和加载指示器。
    *   引入所有 CSS 和 JavaScript 依赖。
    *   包含核心的 JavaScript 逻辑代码。
*   **`css/main.css`:** (假定存在)
    *   包含应用的主要自定义样式，如布局、颜色、字体、气泡消息样式等。
*   **`css/github.min.css`:** (假定存在)
    *   提供 `highlight.js` 所需的 GitHub 主题样式。
*   **`js/marked.min.js`:** (假定存在)
    *   提供 `marked.parse()` 函数，用于 Markdown 解析。
*   **`js/highlight.min.js`:** (假定存在)
    *   提供代码块高亮功能，通常通过 `hljs.highlightElement()` 或类似方法被调用。
*   **内联 JavaScript (`<script>` in `index.html`):**
    *   **DOM 操作:** 获取页面元素引用，动态更新聊天区域内容，处理占位符显示/隐藏。
    *   **事件处理:** 监听输入框的 `paste`, `input`, `focus`, `blur`, `keydown` 事件；监听发送按钮的 `click` 事件。
    *   **输入处理 (`extractContentFromInput`):** 从 `contenteditable` div 中提取文本和 base64 图片数据，构造成 API 需要的格式。
    *   **图片处理:** 处理粘贴事件，使用 `FileReader` 将图片转换为 Data URL，并在输入框和预览区显示图片。
    *   **API 交互 (`fetchAIResponse`):**
        *   构建发送给 AI API 的请求体（包含模型、消息历史、流式传输标志等）。
        *   使用 `fetch` 发送 POST 请求。
        *   处理 API 返回的流式响应 (`ReadableStream`)，逐块解码并累积内容。
        *   **安全警告:** API 密钥硬编码在此部分，存在严重安全风险。
    *   **渲染 (`displayUserMessage`, `displayMessageInBubble`, `fetchAIResponse` 内的渲染逻辑):**
        *   将用户和 AI 的消息（包括文本和图片）格式化为聊天气泡并添加到页面。
        *   在接收 AI 响应流时，实时使用 `marked.js` 解析 Markdown 并更新页面。
        *   调用 `highlight.js` (通过 `processCodeBlocks` 函数) 处理渲染后的代码块。
    *   **状态管理:** 维护 `history_messages` 数组来存储对话历史。

## 5. 数据流 (简化)

1.  **用户输入:** 用户在 `contenteditable` 输入框中输入文本或粘贴图片。
2.  **输入处理:**
    *   粘贴图片时，JavaScript 捕获事件，读取图片文件为 Data URL，在输入框和预览区显示图片，并将 base64 数据存储在 `img` 元素的属性中。
    *   点击“发送”按钮或按 `Shift+Enter`。
3.  **内容提取:** `extractContentFromInput` 函数遍历输入框的 DOM 节点，提取文本内容和图片的 base64 数据及 MIME 类型，组合成 `contentParts` 数组。
4.  **API 请求:**
    *   将 `contentParts` 构造成用户消息，添加到 `history_messages`。
    *   调用 `fetchAIResponse` 函数。
    *   该函数将包含 `history_messages` 的请求体发送到配置的 AI API 端点。
5.  **API 响应 (流式):**
    *   AI API 返回 Server-Sent Events (SSE) 流。
    *   `fetchAIResponse` 函数读取流，解码文本块。
6.  **渲染与更新:**
    *   从流数据中提取 AI 回复的内容块 (`contentChunk`)。
    *   累积内容块 (`accumulatedContent`)。
    *   实时使用 `marked.parse()` 将 `accumulatedContent` 转换为 HTML，并更新 AI 消息气泡的内容。
    *   调用 `processCodeBlocks` 对新渲染的代码块进行高亮和添加复制按钮。
    *   将最终的完整 AI 回复添加到 `history_messages`。
7.  **界面更新:** 聊天区域滚动到底部，清空输入框和预览区，更新按钮和加载状态。

## 6. 安装与运行指南

1.  **获取代码:** 将 `index.html` 文件以及 `css` 和 `js` 目录（包含所需的 `.css` 和 `.js` 文件）放置在同一目录下。
2.  **配置 (重要):**
    *   **安全警告:** `index.html` 中的 JavaScript 代码包含了硬编码的 API 配置 (`apiConfig`)，特别是 `key`。**在实际部署或分发前，必须移除或通过安全方式管理此密钥。**
    *   确保 `apiConfig.model` 指定的模型 (`gemini-2.5-pro-exp-03-25`) 确实支持您期望的多模态输入，并且 API 端点 (`apiConfig.baseurl`) 是可访问且正确的。
3.  **运行:**
    *   由于是纯静态文件，可以直接在现代浏览器中通过文件系统打开 `index.html` (例如，双击文件或使用 `file:///` 协议)。
    *   为了获得最佳体验（特别是 `fetch` API 的使用可能涉及 CORS 策略），建议通过一个简单的本地 Web 服务器来提供这些文件。例如，使用 Python 的 `http.server` 模块：
        ```bash
        # 在包含 index.html 的目录下运行
        python -m http.server 8000
        ```
        然后在浏览器中访问 `http://localhost:8000`。